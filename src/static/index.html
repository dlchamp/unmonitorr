<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Unmonitorr Configuration</title>
    <link rel="stylesheet" href="/static/style.css">

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Open+Sans:ital,wght@0,300..800;1,300..800&family=Ubuntu:ital,wght@0,300;0,400;0,500;0,700;1,300;1,400;1,500;1,700&display=swap"
        rel="stylesheet">

</head>

<body>
    <div class="container">
        <h1>Unmonitorr Configuration</h1>
        <form id='config-form' action="/setup" method="post" , accept-charset="utf-8"
            enctype="application/x-www-form-urlencoded">
            <!-- Radarr Settings -->
            <div class="section">
                <h2>Radarr Settings</h2>
                <div class="form-item">
                    <label for="radarr-uri">Radarr URI</label>
                    <input type="text" id="radarr-uri" name="radarr_uri" placeholder="http://localhost:7878"
                        value="{{ radarr_uri }}" pattern="https?://.*"
                        title="Please enter a valid URL starting with http:// or https://" required>
                </div>

                <div class="form-item">
                    <label for="radarr-api-key">Radarr API Key</label>
                    <input type="text" id="radarr-api-key" name="radarr_api_key" placeholder="Your Radarr API Key"
                        value="{{ radarr_api_key}}" maxlength="64" required>
                </div>
            </div>

            <!-- Sonarr Settings -->
            <div class="section">
                <h2>Sonarr Settings</h2>
                <div class="form-item">
                    <label for="sonarr-uri">Sonarr URI</label>
                    <input type="text" id="sonarr-uri" name="sonarr_uri" placeholder="http://localhost:8989"
                        value="{{ sonarr_uri}}" pattern="https?://.*"
                        title="Please enter a valid URL starting with http:// or https://" required>
                </div>
                <div class="form-item"></div>
                <label for="sonarr-api-key">Sonarr API Key</label>
                <input type="text" id="sonarr-api-key" name="sonarr_api_key" placeholder="Your Sonarr API Key"
                    value="{{ sonarr_api_key}}" maxlength="64" required>
            </div>


            <!-- General Settings -->
            <div class="section">
                <h2>General Settings</h2>
                <div class="setting">
                    <input type="checkbox" id="handle-episodes" name="handle_episodes" {% if handle_episodes %}checked{%
                        endif %}>
                    <label for="handle-episodes">Handle Episodes</label>
                    <p>Enable to handle individual episodes.</p>

                </div>

                <div class="setting">
                    <input type="checkbox" id="handle-series" name="handle_series" {% if handle_series %}checked{% endif
                        %}>
                    <label for="handle-series">Handle Series</label>
                    <p>Only series that are 100% available are handled.<br /><strong>Important: Enabling this feature
                            without also enabling "Handle Only Ended Series" means that an ongoing series could be
                            handled
                            if all current episodes are available.</strong>
                    </p>
                </div>

                <div class="setting">
                    <input type="checkbox" id="handle-series-ended-only" name="handle_series_ended_only" {% if
                        handle_series_ended_only %}checked{% endif %}>
                    <label for="handle-series-ended-only">Handle Only Ended Series</label>
                    <p>Extends series handling to only handle completed series that are also "ended."</p>

                </div>

                <div class="setting">
                    <input type="checkbox" id="remove-media" name="remove_media" {% if remove_media %}checked{% endif
                        %}>
                    <label for="remove-media">Remove Media</label>
                    <p>Enabling this will fully delete the media from Sonarr/Radarr.<br /><strong>Important: This does
                            not
                            delete from the file system.</strong></p>
                </div>

                <div class="setting">
                    <input type="checkbox" id="exclude-series" name="exclude_series" {% if exclude_series %}checked{%
                        endif %}>
                    <label for="exclude-series">Exclude Series</label>
                    <p>Prevent the series from being re-imported via lists. Only applies if "Remove Media" is enabled.
                    </p>

                </div>
            </div>
        </form>

        <div id="toast" class="toast hidden">
            <span id="toast-message">You have unsaved changes!</span>
            <button id="reset-button" class="toast-button reset">Reset</button>
            <button id="save-button" class="toast-button save">Save Changes</button>
        </div>

    </div>

    <script>
        document.addEventListener("DOMContentLoaded", () => {
            const form = document.getElementById("config-form");
            const toast = document.getElementById("toast");
            const resetButton = document.getElementById("reset-button");
            const saveButton = document.getElementById("save-button");
            const toastMessage = document.getElementById("toast-message");

            let originalData = new FormData(form);

            const showToast = (message, buttons = true) => {
                toastMessage.textContent = message;
                toast.classList.remove("hidden");
                resetButton.style.display = buttons ? "inline-block" : "none";
                saveButton.style.display = buttons ? "inline-block" : "none";
            };

            const hideToast = () => {
                toast.classList.add("hidden");
            };

            const hasUnsavedChanges = () => {
                const currentData = new FormData(form);
                for (let [key, value] of originalData.entries()) {
                    if (currentData.get(key) !== value) {
                        return true;
                    }
                }
                return false;
            };

            form.addEventListener("input", () => {
                if (hasUnsavedChanges()) {
                    showToast("You have unsaved changes!");
                } else {
                    hideToast();
                }
            });

            resetButton.addEventListener("click", () => {
                for (let [key, value] of originalData.entries()) {
                    const element = form.elements[key];
                    if (element.type === "checkbox") {
                        element.checked = value === "on";
                    } else {
                        element.value = value;
                    }
                }
                hideToast();
            });

            saveButton.addEventListener("click", async () => {
                const formData = new FormData(form);
                try {
                    const response = await fetch("/save-config", {
                        method: "POST",
                        body: formData,
                    });
                    if (response.ok) {
                        originalData = new FormData(form); // Update original data
                        showToast("Changes have been saved!", false);
                        setTimeout(hideToast, 1000);
                    } else {
                        showToast("Failed to save changes!", false);
                    }
                } catch (error) {
                    showToast("An error occurred while saving changes!", false);
                }
            });
        });
    </script>


</body>

</html>
